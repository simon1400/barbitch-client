# Настройка комбинированных услуг

## Обзор реализации

Я добавил функциональность комбинированных услуг, которая позволяет пользователям бронировать несколько услуг одновременно (например, "Prodloužení řas Classic + Gel lak manikúra").

Система автоматически находит последовательные свободные слоты для разных мастеров и создаёт отдельные резервации для каждой услуги.

## Что было реализовано

### 1. Структура файлов

```
client/src/app/book/
├── data/
│   └── combo-services.json                    # Конфигурация комбинированных услуг
├── fetch/
│   ├── comboService.ts                        # API для работы с комбо-услугами
│   └── comboSlotsService.ts                   # Поиск последовательных слотов
├── components/
│   └── ComboServiceItem.tsx                   # Компонент отображения комбо-услуги
├── combo/
│   └── [comboId]/
│       └── page.tsx                           # Страница выбора даты/времени
├── reservation/
│   └── combo/
│       └── [idReservation]/
│           ├── page.tsx                       # Страница подтверждения
│           └── ComboBookForm.tsx              # Форма бронирования
└── page.tsx                                   # Главная страница (обновлена)
```

### 2. Ключевые компоненты

#### **combo-services.json**
Содержит все комбинированные услуги. Каждая услуга включает:
- ID комбо-услуги
- Название и описание
- Общую цену и длительность
- Список входящих услуг с их `serviceId` из Noona API

#### **comboSlotsService.ts**
Основная логика поиска свободных слотов:
- Получает слоты для всех услуг комбо параллельно
- Находит последовательные свободные слоты
- Подбирает разных мастеров для каждой услуги
- Возвращает только те времена, где все услуги могут быть выполнены подряд

#### **Процесс бронирования**
1. Пользователь выбирает комбо-услугу
2. Система показывает доступные даты и времена
3. При выборе времени создаются **несколько резерваций** (по одной для каждой услуги)
4. На странице подтверждения отображаются все услуги с их мастерами
5. При финальном подтверждении создаются **несколько событий** в Noona

## Что нужно настроить

### ⚠️ ВАЖНО: Замените SERVICE_ID в JSON файле

Откройте файл `client/src/app/book/data/combo-services.json` и замените все плейсхолдеры на реальные ID услуг из вашего Noona API:

```json
{
  "serviceId": "SERVICE_ID_RESNICY_CLASSIC",  // ← Заменить на реальный ID
  "title": "Prodloužení řas Classic",
  "minutes": 90,
  "order": 1
}
```

#### Как найти ID услуг:

1. **Через API запрос:**
   ```bash
   curl -H "Authorization: Bearer YOUR_TOKEN" \
        https://api.noona.is/v1/marketplace/companies/YOUR_COMPANY_ID/event_types/expanded
   ```

2. **Или посмотрите в существующих обычных услугах:**
   - Откройте браузер DevTools на странице `/book`
   - Посмотрите на network запросы
   - Найдите ID нужных услуг в ответе API

### Список serviceId, которые нужно заменить:

- `SERVICE_ID_RESNICY_CLASSIC` → ID услуги "Prodloužení řas Classic"
- `SERVICE_ID_2D_RASY` → ID услуги "2D řasy"
- `SERVICE_ID_3D_RASY` → ID услуги "3D řasy"
- `SERVICE_ID_GEL_MANICURE` → ID услуги "Gel lak manikúra"
- `SERVICE_ID_PRODLOUZENI_NEHTU` → ID услуги "Prodloužení nehtů"
- `SERVICE_ID_DESIGN` → ID услуги "Design"
- `SERVICE_ID_FRENCH_DESIGN` → ID услуги "Francouzský design"

## Как это работает для пользователя

### Процесс бронирования:

1. **Выбор комбо-услуги**
   - Пользователь заходит на `/book`
   - Видит аккордеон "Kombinované balíčky" вверху списка
   - Выбирает нужную комбинацию (например, "Prodloužení řas Classic + Gel lak manikúra")

2. **Выбор даты и времени**
   - Система показывает календарь с доступными датами
   - Отображаются только те времена, где есть последовательные слоты для обеих услуг
   - Например: 10:00 доступно, только если с 10:00-11:30 свободен мастер по ресницам И с 11:30-13:00 свободен мастер по маникюру

3. **Подтверждение**
   - Показывается детальная информация о каждой услуге
   - Время начала каждой услуги
   - Мастер для каждой услуги
   - Общая стоимость
   - Форма для ввода контактных данных

4. **Создание бронирования**
   - Создаются 2 (или более) отдельные резервации в Noona
   - Все резервации привязаны к одному клиенту
   - После подтверждения клиент видит страницу благодарности

## Алгоритм поиска последовательных слотов

```
Для времени 10:00:
1. Проверить: есть ли мастер для "Ресницы" с 10:00 до 11:30? ✓
2. Проверить: есть ли мастер для "Маникюр" с 11:30 до 13:00? ✓
3. Если оба условия выполнены → показать время 10:00

Для времени 10:30:
1. Проверить: есть ли мастер для "Ресницы" с 10:30 до 12:00? ✓
2. Проверить: есть ли мастер для "Маникюр" с 12:00 до 13:30? ✗
3. Если хотя бы одно условие не выполнено → НЕ показывать время 10:30
```

## Особенности реализации

### ✅ Преимущества:

- **Для пользователя выглядит как одна услуга**, но на бэкенде это несколько резерваций
- **Автоматический подбор мастеров** - система сама находит доступных специалистов
- **Гибкость** - легко добавить новые комбинации через JSON
- **Последовательность** - все услуги идут одна за другой без перерывов

### ⚠️ Ограничения:

- Комбо-услуги могут быть только в один день
- Услуги выполняются строго последовательно (нельзя назначить параллельно)
- Если один из мастеров недоступен в нужное время, весь слот становится недоступен

## Тестирование

### Перед запуском на production:

1. **Замените все SERVICE_ID** в `combo-services.json`
2. **Проверьте цены** - убедитесь, что они соответствуют реальным
3. **Протестируйте процесс бронирования:**
   - Выберите комбо-услугу
   - Проверьте, что отображаются корректные свободные слоты
   - Забронируйте и проверьте создание резерваций в Noona API
   - Убедитесь, что обе услуги появились в системе

4. **Проверьте edge cases:**
   - Что происходит, если нет свободных слотов?
   - Что если пользователь вернётся назад в браузере?
   - Очищается ли localStorage после успешного бронирования?

## Поддержка и расширение

### Добавление новой комбо-услуги:

1. Откройте `combo-services.json`
2. Добавьте новый объект в массив `services`:

```json
{
  "id": "combo-custom",
  "title": "Ваша комбинация",
  "description": "Описание",
  "price": 2000,
  "totalMinutes": 180,
  "image": "/assets/images/combo-custom.jpg",
  "services": [
    {
      "serviceId": "REAL_SERVICE_ID_1",
      "title": "Услуга 1",
      "minutes": 90,
      "order": 1
    },
    {
      "serviceId": "REAL_SERVICE_ID_2",
      "title": "Услуга 2",
      "minutes": 90,
      "order": 2
    }
  ]
}
```

### Изменение логики поиска слотов:

Если нужно изменить логику (например, добавить перерыв между услугами), редактируйте функцию `findSequentialSlots` в файле `comboSlotsService.ts`.

## Вопросы и поддержка

Если возникнут вопросы или проблемы:
1. Проверьте консоль браузера на ошибки
2. Убедитесь, что все SERVICE_ID заменены на реальные
3. Проверьте network tab - все ли API запросы успешны
4. Проверьте localStorage - сохраняются ли `comboReservationIds` и `comboId`

---

**Готово!** После замены SERVICE_ID система будет полностью функциональна.
